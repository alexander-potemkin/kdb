
<!DOCTYPE html>
<html>
<head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>Networking on Ubuntu &mdash; My KDB</title>

    <link rel="shortcut icon" href="../../img/favicon.ico">
    <link rel="stylesheet" href="../../css/alabaster.css" type="text/css">
    <link rel="stylesheet" href="../../css/alabaster-overrides.css" type="text/css">

    

    
      <script src="../../search/main.js"></script>
    

    

    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

    
  
</head>
<body>

  <div class="document">
    <div class="documentwrapper">
      <div class="bodywrapper">
        <div class="body" role="main">
          
            <h1 id="networking-on-ubuntu">Networking on Ubuntu</h1>
<p>The content below is only for Ubuntu 18.04 and higher (the network has been changed dramatically in 18.04).</p>
<p>UFW on top of Docker (as per <a href="https://github.com/chaifeng/ufw-docker">the doc</a>)</p>
<pre><code class="language-bash">sudo wget -O /usr/local/bin/ufw-docker \
  https://github.com/chaifeng/ufw-docker/raw/master/ufw-docker
sudo chmod +x /usr/local/bin/ufw-docker
sudo ufw-docker install
sudo ufw-docker check
</code></pre>
<p><strong>Firewall check</strong></p>
<pre><code class="language-bash">sudo ufw status verbose
sudo iptables -S
sudo iptables -nvL
</code></pre>
<p>B<strong>asic firewall rules</strong> (<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-18-04#step-2-%E2%80%94-setting-up-default-policies">ref</a>)</p>
<pre><code class="language-bash">sudo ufw allow ssh
sudo ufw allow proto tcp from any to any port 80,443 #HTTP &amp; HTTPS
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw show added #shows rules, without enabling firewall
sudo ufw status numbered #shows rules, numbered
sudo ufw delete 2 #remove the rule
sudo ufw enable
sudo ufw disable
</code></pre>
<p>Enabling NAT (as per <a href="https://askubuntu.com/questions/1050816/ubuntu-18-04-as-a-router">article</a>)</p>
<pre><code class="language-bash">sudo ufw show added #check status
sudo ufw enable
sudo ufw logging on

#optional
iptables --flush            # Flush all the rules in filter and nat tables    
iptables --table nat --flush    
iptables --delete-chain    # Delete all chains that are not in default filter and nat table    
iptables --table nat --delete-chain

sudo vi /etc/default/ufw #change to DEFAULT_FORWARD_POLICY=&quot;ACCEPT&quot;
sudo vi /etc/ufw/sysctl.conf #uncomment net/ipv4/ip_forward=1 &amp; net/ipv4/conf/all/forwarding=1

sudo vi /etc/ufw/before.rules #add the following at the very top
</code></pre>
<pre><code class="language-bash"># nat Table rules
*nat
:POSTROUTING ACCEPT [0:0]
# Forward traffic from eth1 (ens4) through eth0 (ens3).
-A POSTROUTING -s 192.168.168.0/24 -o ens3 -j MASQUERADE
#-A -&gt; Append, -s -&gt; source specification, -o -&gt; out interface, -j -&gt; where to jump
# don't delete the 'COMMIT' line or these nat table rules won't be processed
COMMIT
</code></pre>
<pre><code class="language-bash">sudo ufw disable &amp;&amp; sudo ufw enable
</code></pre>
<p><strong>Limiting an access for a specific network interface</strong> (<a href="https://serverfault.com/questions/270715/ubuntu-ufw-set-a-rule-on-a-per-interface-basis">ref</a>)</p>
<blockquote>
<p>By default, ufw will apply rules to all available interfaces. To<br />
limit  this,  specify DIRECTION on INTERFACE, where DIRECTION is<br />
one of in or out (interface aliases  are  not  supported).   For<br />
example,  to  allow  all  new incoming http connections on eth0,<br />
use:</p>
</blockquote>
<p>ufw allow in on eth0 to any port 80 proto tcp</p>
<blockquote></blockquote>
<pre><code class="language-bash">ufw allow in on eth1 to [eth1 ip addr] port 80 proto tcp
</code></pre>
<p>So, denying everything on public port and only enabling specific things would looks like the following:</p>
<pre><code class="language-bash">sudo ufw default deny incoming on ens3 #default to public deny
sudo ufw allow in on ens4 from any to any #allow everything on LAN
sudo ufw allow out on ens4 from any to any #allow everything on LAN
sudo ufw enable #do disk snapshot first!

sudo ufw allow proto tcp on ens3 from any to any port 22
sudo ufw allow proto tcp from 10.66.66.0/24 to any port 80,443 #allow traffic via LAN

sudo ufw allow from 192.168.168.0/24 #allow from internal network

</code></pre>
<p><strong>Basic security features</strong></p>
<p>Move SSHd to another port</p>
<pre><code class="language-bash">sudo vi /etc/sshd/sshd_config #change Port's 22 to anything you like
sudo service sshd restart #it shall be available on a new port

</code></pre>
<h3 id="troubleshooting-connections-good-doc-here">Troubleshooting connections (good <a href="https://help.mulesoft.com/s/article/How-to-capture-network-traffic-between-two-systems">doc here</a>)</h3>
<pre><code class="language-bash">sudo tcpdump -vvv -n host IP
sudo tcpdump -vvv -i ens3 host IP port 22
sudo tcpdump -n -vvv -i ens3 'host IP and port 22'

</code></pre>
<h3 id="configuring-second-network-interface">Configuring second network interface</h3>
<aside>
‚ùó DO NOT SPECIFY gateway4 - it's a [default gateway for all traffic](https://askubuntu.com/questions/1062902/ubuntu-18-04-netplan-static-routes), on all interfaces - unless you really know what to do.
It overrides the DHCP settings and you will lose access to your server.

</aside>

<aside>
‚ùó DO NOT USE TABS in YML files. Not on Ubuntu 18.04 at least. That break netplan ‚áí loosing network access to the server.

</aside>

<aside>
üí° It's safe to make configuration change in a separate file, then try out things with `sudo netplan --debug try --config-file ~/50-cloud-init.yaml`

</aside>

<p><strong>Ubuntu 18.04 (<a href="https://serverspace.io/support/help/how-to-configure-static-ip-address-on-ubuntu-18-04/">ref</a>)</strong></p>
<pre><code class="language-bash">cd /etc/netplan &amp;&amp; ls
sudo vi 50-cloud-init.yaml

#file name starts with 50 something; it won't be overridden, as it's generated during the first init
</code></pre>
<p>Here is the resulting example file:</p>
<pre><code class="language-bash">network:
    ethernets:
        ens3:
            addresses: []
            dhcp4: true
            optional: true
        **ens4:
               addresses: [192.168.168.10/24, ]**

    version: 2
</code></pre>
<pre><code class="language-bash">sudo netplan --debug apply
</code></pre>
<p><strong>Ubuntu 20.04 (<a href="https://ostechnix.com/how-to-configure-ip-address-in-ubuntu-18-04-lts/">ref</a>)</strong></p>
<pre><code class="language-bash">cd /etc/netplan &amp;&amp; ls
sudo vi 01-netcfg.yaml
sudo netplan try
sudo netplan --debug apply
</code></pre>
<p>Here is the resulting example file:</p>
<pre><code class="language-bash">network:
  ethernets:
    ens4:
      dhcp4: no
      addresses: 
        - 192.168.168.1/24

  version: 2
</code></pre>
<p><strong>Setting up routing for the second interface</strong> (18.04; <a href="https://askubuntu.com/questions/1062902/ubuntu-18-04-netplan-static-routes/1062931#1062931?newreg=e938644cf7284879aa6c41b97ddad51c">ref</a>)</p>
<p><strong><em>Temporary</em> one:</strong></p>
<pre><code class="language-bash">sudo route add -net 10.0.0.0/8 gw 192.168.1.1 eth0
sudo route del -host IP gw 192.168.168.1 ens4
sudo route add -host IP gw 192.168.168.10 ens4
sudo route add default gw 192.168.168.1 ens4
</code></pre>
<p><strong>Permanent one:</strong></p>
<pre><code class="language-bash">sudo vi /etc/netplan/50-cloud-init.yaml
</code></pre>
<p>And add routes directive:</p>
<pre><code class="language-bash">ens4:
               addresses: [192.168.168.10/24, ]
               routes:
                       - to: 10.0.0.0/8
                         via: 192.168.168.1
</code></pre>
<p>Check kernel level packets forward:</p>
<pre><code class="language-bash">cat /proc/sys/net/ipv4/ip_forward
</code></pre>
<h3 id="single-interface-configuration-netplan">Single interface configuration netplan:</h3>
<pre><code class="language-bash">network:
    ethernets:
        ens3:
               addresses: [192.168.168.22/24, ]
               gateway4: 192.168.168.1 
               routes:
                       - to: 10.0.0.0/8
                         via: 192.168.168.1
    version: 2
</code></pre>
<h3 id="one-liners">One liners</h3>
<p>Extract external IP address and add <code>1</code> at the end - which is usually a gateway.</p>
<pre><code class="language-bash">ip addr show ens3 | awk '/inet/ {print $2}' | cut -d/ -f1 | head -1 | awk -F '.' '{ print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.&quot;1;}
</code></pre>
<p>or use </p>
<pre><code class="language-bash">sudo apt-get install sipcalc
sipcalc -I ens3
</code></pre>
<p>that gives first server in the network (which is usually a gateway)</p>
<pre><code class="language-bash">sipcalc -I ens3 -i | grep &quot;Usable range&quot; | cut -d &quot;-&quot; -f 2 | xargs
</code></pre>
<p>Temporary setup default router</p>
<pre><code class="language-bash">
sudo route add default gw `sipcalc -I ens3 -i | grep &quot;Usable range&quot; | cut -d &quot;-&quot; -f 2 | xargs` ens3

</code></pre>
<p>Revoke routing back</p>
<pre><code class="language-bash">sudo route del default gw `sipcalc -I ens3 -i | grep &quot;Usable range&quot; | cut -d &quot;-&quot; -f 2 | xargs` ens3
</code></pre>
            
          
        </div>
      </div>
    </div>
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        
          
            
  <h1 class="logo"><a href="../..">My KDB</a></h1>



          
            



<h3>Table Of Contents</h3>

<nav>
  
  
    <ul>
    
      <li><a href="#troubleshooting-connections-good-doc-here">Troubleshooting connections (good doc here)</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#configuring-second-network-interface">Configuring second network interface</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#single-interface-configuration-netplan">Single interface configuration netplan:</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#one-liners">One liners</a></li>
      <ul>
    
  </ul>
    
  </ul>
  

  
</nav>
          
            
  <h3>Related Topics</h3>
  <ul>
    
      <li>Previous: <a href="../Swagger%20%28%26GitHub%29/" title="previous chapter">
        Swagger (&GitHub)
      </a></li>
    
    
      <li>Next: <a href="../Ubuntu%20-%20Unnattended%20upgrades/" title="next chapter">
        Unnattended upgrades
      </a></li>
    
  </ul>

          
            <div id="searchbox" style="display: none;" role="search">
  <h3>Quick search</h3>
  <form class="search" action="../../search.html" method="get">
    <input name="q" type="text">
    <input value="Go" type="submit">
  </form>
  <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
  </p>
</div>
<script type="text/javascript">
  document.getElementById("searchbox").style.display = "block";
</script>
          
        
      </div>
    </div>
    <div class="clearer"></div>
  </div>

  
    <div class="footer">
      
      
        
        Powered by <a href="http://www.mkdocs.org">mkdocs 1.4.2</a>
        &amp; <a href="https://github.com/iamale/mkdocs-alabaster">mkdocs-alabaster</a>
      
    </div>
  

  <!--
  MkDocs version      : 1.4.2
  Docs Build Date UTC : 2022-11-29 15:13:35.280975+00:00
  -->
</body>
</html>