
<!DOCTYPE html>
<html>
<head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>VPN (Wireguard) &mdash; My KDB</title>

    <link rel="shortcut icon" href="../../img/favicon.ico">
    <link rel="stylesheet" href="../../css/alabaster.css" type="text/css">
    <link rel="stylesheet" href="../../css/alabaster-overrides.css" type="text/css">

    

    
      <script src="../../search/main.js"></script>
    

    

    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

    
  
</head>
<body>

  <div class="document">
    <div class="documentwrapper">
      <div class="bodywrapper">
        <div class="body" role="main">
          
            <h1 id="vpn-wireguard">VPN (Wireguard)</h1>
<h2 id="server">Server</h2>
<p>Routing thing: <a href="https://www.poftut.com/add-new-route-ubuntu-linux/">https://www.poftut.com/add-new-route-ubuntu-linux/</a></p>
<p>sudo route add -net 10.0.0.0/8 gw 192.168.168.1 ens4</p>
<aside>
❗ Use Ubuntu 20.04 LTS (18.04 has a mess with wireguard availability).

</aside>

<h3 id="wireguard-configuration-as-per-that-script">Wireguard configuration (as per <a href="https://github.com/angristan/wireguard-install">that script</a>)</h3>
<pre><code class="language-bash">curl -O https://raw.githubusercontent.com/angristan/wireguard-install/master/wireguard-install.sh
chmod +x wireguard-install.sh
sudo ./wireguard-install.sh
</code></pre>
<aside>
❗ Make sure to add `PersistentKeepalive = 25`  in the 'Peer' section, at the end of each key file manually.
Or, alter the script, near 290-s lines:

`[Peer]
PublicKey = ${SERVER_PUB_KEY}
PresharedKey = ${CLIENT_PRE_SHARED_KEY}
Endpoint = ${ENDPOINT}
AllowedIPs = 0.0.0.0/0,::/0
PersistentKeepalive = 25" >>"${HOME_DIR}/${SERVER_WG_NIC}-client-${CLIENT_NAME}.conf"`

</aside>

<p>As a nice addition to the keys adding process, the following line near 313 line of the script save some time: <code>cat "${HOME_DIR}/${SERVER_WG_NIC}-client-${CLIENT_NAME}.conf"</code></p>
<p>For the office computers with internal network AND to the intranet (192.168.168.0/24), add that:</p>
<pre><code class="language-bash">AllowedIPs = 1.0.0.0/8, 2.0.0.0/8, 3.0.0.0/8, 4.0.0.0/6, 8.0.0.0/7, 11.0.0.0/8, 12.0.0.0/6, 16.0.0.0/4, 32.0.0.0/3, 64.0.0.0/2, 128.0.0.0/3, 160.0.0.0/5, 168.0.0.0/6, 172.0.0.0/12, 172.32.0.0/11, 172.64.0.0/10, 172.128.0.0/9, 173.0.0.0/8, 174.0.0.0/7, 176.0.0.0/4, 192.0.0.0/9, 192.128.0.0/11, 192.160.0.0/13, 192.168.168.0/24, 192.169.0.0/16, 192.170.0.0/15, 192.172.0.0/14, 192.176.0.0/12, 192.192.0.0/10, 193.0.0.0/8, 194.0.0.0/7, 196.0.0.0/6, 200.0.0.0/5, 208.0.0.0/4, 94.140.14.14/32, 94.140.15.15/32
</code></pre>
<p>All traffic's AllowedIPs is <code>0.0.0.0/0, ::/0</code>.</p>
<p>Just the cloud traffic AllowedIPs is  <code>192.168.168.0/24, IP/32, IP/32</code> - which is intranet network and DNS server's IPs with /32 network on it.</p>
<p>Working note: netmask 255.255.255.0 network is in use.</p>
<p>Server side (very limited) logging:</p>
<pre><code class="language-bash">sudo su -
echo &quot;module wireguard +p&quot; | tee /sys/kernel/debug/dynamic_debug/control
touch /var/log/wireguard.log
nohup dmesg -T --follow | egrep &quot;(wireguard:|wg0)&quot; &gt;&gt; /var/log/wireguard.log
</code></pre>
<p>Some usefull commands:</p>
<pre><code class="language-bash">wg show all dump
</code></pre>
<p>Generate QR code</p>
<pre><code class="language-bash">qrencode -t ansiutf8 -l L &lt; ...conf #to generate QR code
</code></pre>
<p>Various:</p>
<pre><code class="language-bash"># sudo vi /etc/sysctl.conf
# sudo sysctl -p
net.ipv4.ip_forward = 1
</code></pre>
<h3 id="adding-wireguard-to-networkmanager-gui-on-ubuntu-2004-based">Adding WireGuard to NetworkManager GUI on Ubuntu 20.04 based</h3>
<p>The result feels like sucks.</p>
<p>as per <a href="https://github.com/max-moser/network-manager-wireguard/issues/50#issuecomment-922104777">the doc</a>:</p>
<pre><code class="language-bash">sudo apt install wireguard git dh-autoreconf libglib2.0-dev intltool build-essential libgtk-3-dev libnma-dev libsecret-1-dev network-manager-dev resolvconf
git clone https://github.com/max-moser/network-manager-wireguard
cd network-manager-wireguard
./autogen.sh --without-libnm-glib

./configure --without-libnm-glib --prefix=/usr --sysconfdir=/etc --libdir=/usr/lib/x86_64-linux-gnu --libexecdir=/usr/lib/NetworkManager --localstatedir=/var

make
sudo make install
</code></pre>
<p>Now go to the network manager GUI and create WireGuard connection from there.</p>
<h3 id="configuring-client">Configuring client</h3>
<p>As per <a href="https://www.cyberciti.biz/faq/how-to-import-wireguard-profile-using-nmcli-on-linux/">the page</a>.</p>
<pre><code class="language-bash">sudo apt install wireguard #if required
</code></pre>
<ol>
<li>Importing WireGuard config into network manager:</li>
</ol>
<pre><code class="language-bash">nmcli connection import type wireguard file $file
</code></pre>
<ol>
<li>Check the import is good:</li>
</ol>
<pre><code class="language-bash">nmcli connection show #network manager
sudo wg show #in Wireguard

#in more details
nmcli connection show $connection_name
sudo wg show $if_name 
</code></pre>
<ol>
<li>Bring connection up or down</li>
</ol>
<pre><code class="language-bash">nmcli connection up $connection_name
nmcli connection down $connection_name
</code></pre>
<pre><code class="language-bash">
nmcli connection add type wireguard ifname wg0 con-name my-wg0
nmcli connection import type wireguard file wg.conf
nmcli --show-secrets --ask connection up wg
nmcli --show-secrets --ask connection down wg

CONF_FILE=&quot;wg-ru.conf&quot;
nmcli connection add type wireguard ifname wg1 con-name wg-ru
nmcli connection import type wireguard file $CONF_FILE
nmcli --show-secrets --ask connection up wg-ru
#nmcli connection modify type wireguard file wg.conf
</code></pre>
<p>ToDo:</p>
<ul>
<li>check for <a href="https://www.procustodibus.com/">https://www.procustodibus.com/</a></li>
</ul>
<hr />
<h3 id="archive">Archive</h3>
<hr />
<p>sysctl net.ipv4.ip_forward=1</p>
<p><a href="https://github.com/angristan/wireguard-install/blob/master/wireguard-install.sh">https://github.com/angristan/wireguard-install/blob/master/wireguard-install.sh</a></p>
<p>There is no such parameter in WireGuard as, clients can go quiet at any time and expect to be able to talk to the server again at any time later.</p>
<p>Specifically, the protocol requires a client to handshake with the server to begin a session. To maintain the session a client must handshake at least once every 180 seconds. In practice, the handshake happens some time between 120 and 180 seconds.</p>
<p>If a client stops talking and at a later time wants to start talking again, providing the server is active then,if the time since last talking is:</p>
<p>&lt;120 seconds, carry on as normal</p>
<blockquote>
<p>=120 seconds, &lt;=180 seconds carry on and handshake within 60 seconds.<br />
180 seconds, handshake and carry on<br />
The server and client maintain timers so that they always know what to do and when to do it.<br />
</p>
</blockquote>
<p>Thus, WireGuard is a connectionless protocol and there is no need to worry about timeouts. A client is either talking (and handshaking as required) or silent.</p>
<p><a href="https://serverfault.com/questions/1045653/set-vpn-connection-timeout-in-wireguard">https://serverfault.com/questions/1045653/set-vpn-connection-timeout-in-wireguard</a></p>
<p><a href="https://github.com/pirate/wireguard-docs">https://github.com/pirate/wireguard-docs</a></p>
<h3 id="freebsd-stuff">FreeBSD stuff</h3>
<p>rxtun option</p>
<p><a href="https://discuss.vultr.com/discussion/979/freebsd-vtnet0-tuning">https://discuss.vultr.com/discussion/979/freebsd-vtnet0-tuning</a></p>
<p><a href="https://forums.openvpn.net/viewtopic.php?t=25039">https://forums.openvpn.net/viewtopic.php?t=25039</a></p>
<p><code>dd if=/dev/random of=myfile.dat bs=$(( 1024 * 1024 )) count=100</code></p>
<h3 id="openvpn-linux-stuff">OpenVPN Linux stuff</h3>
<p><a href="https://github.com/angristan/openvpn-install">https://github.com/angristan/openvpn-install</a> → seems to be more mature</p>
<p><a href="https://github.com/Nyr/openvpn-install">https://github.com/Nyr/openvpn-install</a></p>
<p><a href="https://www.linux-kvm.org/page/Tuning_KVM">https://www.linux-kvm.org/page/Tuning_KVM</a></p>
<h3 id="vyos">VyOS</h3>
<p>Didn't really like it, feels like too much complicated, not mature / supported / stable enough to trust it completely. Would rather choose *BSD based router</p>
<p><a href="https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/#Final_Results">https://blog.kroy.io/2019/08/23/battle-of-the-virtual-routers/#Final_Results</a></p>
<p><a href="https://www.reddit.com/r/networking/comments/2g9nh6/linux_routers_and_your_thoughts/">https://www.reddit.com/r/networking/comments/2g9nh6/linux_routers_and_your_thoughts/</a></p>
<p><a href="https://vyos.io/subscriptions/support/">https://vyos.io/subscriptions/support/</a></p>
            
          
        </div>
      </div>
    </div>
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        
          
            
  <h1 class="logo"><a href="../..">My KDB</a></h1>



          
            



<h3>Table Of Contents</h3>

<nav>
  
  
    <ul>
    
      <li><a href="#server">Server</a></li>
      <ul>
    
      <li><a href="#wireguard-configuration-as-per-that-script">Wireguard configuration (as per that script)</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#adding-wireguard-to-networkmanager-gui-on-ubuntu-2004-based">Adding WireGuard to NetworkManager GUI on Ubuntu 20.04 based</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#configuring-client">Configuring client</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#archive">Archive</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#freebsd-stuff">FreeBSD stuff</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#openvpn-linux-stuff">OpenVPN Linux stuff</a></li>
      <ul>
    
  </ul>
    
      <li><a href="#vyos">VyOS</a></li>
      <ul>
    
  </ul>
    
  </ul>
    
  </ul>
  

  
</nav>
          
            
  <h3>Related Topics</h3>
  <ul>
    
      <li>Previous: <a href="../Ubuntu/" title="previous chapter">
        Ubuntu
      </a></li>
    
    
      <li>Next: <a href="../Various/" title="next chapter">
        1Password to Bitwarden migration
      </a></li>
    
  </ul>

          
            <div id="searchbox" style="display: none;" role="search">
  <h3>Quick search</h3>
  <form class="search" action="../../search.html" method="get">
    <input name="q" type="text">
    <input value="Go" type="submit">
  </form>
  <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
  </p>
</div>
<script type="text/javascript">
  document.getElementById("searchbox").style.display = "block";
</script>
          
        
      </div>
    </div>
    <div class="clearer"></div>
  </div>

  
    <div class="footer">
      
      
        
        Powered by <a href="http://www.mkdocs.org">mkdocs 1.4.2</a>
        &amp; <a href="https://github.com/iamale/mkdocs-alabaster">mkdocs-alabaster</a>
      
    </div>
  

  <!--
  MkDocs version      : 1.4.2
  Docs Build Date UTC : 2022-11-29 15:13:35.286620+00:00
  -->
</body>
</html>