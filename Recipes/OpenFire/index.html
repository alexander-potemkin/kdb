
<!DOCTYPE html>
<html>
<head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>OpenFire &mdash; My KDB</title>

    <link rel="shortcut icon" href="../../img/favicon.ico">
    <link rel="stylesheet" href="../../css/alabaster.css" type="text/css">
    <link rel="stylesheet" href="../../css/alabaster-overrides.css" type="text/css">

    

    
      <script src="../../search/main.js"></script>
    

    

    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

    
  
</head>
<body>

  <div class="document">
    <div class="documentwrapper">
      <div class="bodywrapper">
        <div class="body" role="main">
          
            <p>To enable SSL certificates under Cloudron:</p>
<ul>
<li>nginx is running on the host (without Docker) and SSL certs are stored at <code>/home/yellowtent/platformdata/nginx/cert/</code><br />
<code>openssl x509 -in certificate.pem -text</code>  to verify a certificate</li>
<li>you can't mount that folder to Docker image, as only <code>/mnt</code>, <code>/media</code>, <code>/opt</code> and <code>/srv</code> could be mounted from within Cloudron</li>
<li><code>cd /srv &amp;&amp; ln -s /home/yellowtent/platformdata/nginx/cert/</code>  and adding a <em>read-only</em> mount creates <code>/media/NginxSSLCertificates/</code> folder inside OpenFire</li>
<li><code>/app/data/conf/security/hotdeploy</code> seems to be used for the certificates monitor extension</li>
</ul>
<pre><code class="language-bash">openssl pkcs12 -export -passout pass:changeit -in /etc/letsencrypt/live/&lt;your-hostname&gt;/fullchain.pem -inkey /etc/letsencrypt/live/&lt;your-hostname&gt;/privkey.pem -name &lt;your-hostname&gt; -out cert.p12

keytool -delete -keystore /opt/openfire/resources/security/keystore -alias &lt;your-hostname&gt; -storepass changeit -noprompt

keytool -importkeystore -deststorepass changeit -srcstorepass changeit -destkeystore /opt/openfire/resources/security/keystore -srckeystore cert.p12 -srcstoretype PKCS12 -deststoretype pkcs12

systemctl stop openfire
systemctl start openfire
</code></pre>
<p>or this <a href="https://gist.github.com/fabiomontefuscolo/317aeed542bc4bcd3959250f360c83f0">gist</a> </p>
<p>my problem now - it's to understand where are let's encrypt files... or shall I... I just need pkcs12 file</p>
<p>Here is what certbot generates, as per the documentation:</p>
<pre><code>This directory contains your keys and certificates.

`privkey.pem`  : the private key for your certificate.
`fullchain.pem`: the certificate file used in most server software.
`chain.pem`    : used for OCSP stapling in Nginx &gt;=1.3.7.
`cert.pem`     : will break many server configurations, and should not be used without reading further documentation (see link below).
</code></pre>
<p>Here is what I'm getting at Cloudron:</p>
<pre><code>root@server:/home/yellowtent/platformdata/nginx/cert# file _.mydomain.co*
_.mydomain.co.cert: PEM certificate
_.mydomain.co.csr:  data
_.mydomain.co.key:  ASCII text
</code></pre>
<p>I guess I'm missing privkey.pem...  =&gt; it seems like I'm not, it's a <code>*.key</code> file, so:</p>
<p><code>privkey.pem</code> =&gt; <code>_.mydomain.co.key</code><br />
<code>fullchain.pem</code>  =&gt; <code>_.mydomain.co.cert</code></p>
<pre><code>cd /app/data
openssl pkcs12 -export -passout pass:superpass -in /media/NginxSSLCertificates/_.mydomain.co.cert -inkey /media/NginxSSLCertificates/_.mydomain.co.key -name '*.mydomain.co' -out cert.p12

cp /app/resources/security/keystore keystore.backup
rm /app/resources/security/keystore

keytool -importkeystore -deststorepass superpass -srcstorepass superpass -destkeystore /app/resources/security/keystore -srckeystore cert.p12 -srcstoretype PKCS12 -deststoretype pkcs12

</code></pre>
<p>keytool command crashed the whole process, so I decided to go without Docker based setup and just use deb file (http://www.igniterealtime.org/downloadServlet?filename=openfire/openfire_4.7.3_all.deb)</p>
<h1 id="installing-openfire-on-ubuntu-2004">Installing OpenFire on Ubuntu 20.04</h1>
<pre><code class="language-bash">export DOMAIN_NAME=&lt;DOMAIN_NAME&gt;
sudo apt update &amp;&amp; sudo apt upgrade
sudo apt install default-jdk certbot python3-certbot-nginx nginx
wget http://www.igniterealtime.org/downloadServlet?filename=openfire/openfire_4.7.3_all.deb
sudo dpkg -i *openfire*.deb # ignore the /var/lib/openfire warning
sudo service openfire status
</code></pre>
<p>Install 'Certificate Manager' plugin, this will create <code>hotdeploy</code> directory, return back to the command line</p>
<pre><code class="language-bash">sudo tee -a /etc/letsencrypt/renewal-hooks/post/openfire.sh  &gt; /dev/null &lt;&lt;EOT
#!/bin/bash
cp /etc/letsencrypt/live/$DOMAIN_NAME/privkey.pem /usr/share/openfire/resources/security/hotdeploy/$DOMAIN_NAME-privkey.pem
cp /etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem /usr/share/openfire/resources/security/hotdeploy/$DOMAIN_NAME-fullchain.pem
chown openfire:openfire /usr/share/openfire/resources/security/hotdeploy/*
EOT

sudo chmod +x /etc/letsencrypt/renewal-hooks/post/openfire.sh

sudo certbot certonly --standalone --agree-tos -d $DOMAIN_NAME --register-unsafely-without-email # optional --email &lt;YOUR_EMAIL&gt; 

sudo certbot --nginx --agree-tos -d '*.'$DOMAIN_NAME --register-unsafely-without-email


</code></pre>
<p>Dashboard will still show error message, which seems to be fixed by (as per <a href="https://discourse.igniterealtime.org/t/a-certificate-for-the-domain-of-this-server-is-missing-error-despite-the-certificate-is-there/92177">forum thread</a> by a wildcard certificate or specific mentions of the certificates required.</p>
<p>Wildcard let's encrypt certificate is an issue, as it require DNS challenge, that can't be automated in most of the DNS providers. But here is a <a href="https://gist.github.com/utek/ba08e9ed8208342817743c0cc25ab697">gist</a> on how to call DNS challenge, if an option would be found.</p>
<p>Waiting for the feedback on the <a href="https://discourse.igniterealtime.org/t/a-certificate-for-the-domain-of-this-server-is-missing-error-despite-the-certificate-is-there/92177">forum thread</a>  on this since 2022-10-26</p>
<p>Pick up on the terminal by: <code>export $DOMAIN_NAME=xmpp.mydomain.co</code></p>
<p><strong>ToDo:</strong><br />
- cron certbot execution<br />
- check STUN server plugin</p>
<p><strong>Drafts:</strong></p>
<pre><code>
sudo certbot certonly --standalone --agree-tos -d $DOMAIN_NAME --register-unsafely-without-email # optional --email &lt;YOUR_EMAIL&gt; 

sudo openssl pkcs12 -export -passout pass:mypass -in /etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem -inkey /etc/letsencrypt/live/$DOMAIN_NAME/privkey.pem -name $DOMAIN_NAME -out cert.p12

sudo cp /usr/share/openfire/resources/security/keystore keystore.backup

keytool -delete -keystore /usr/share/openfire/resources/security/keystore -alias $DOMAIN_NAME -storepass changeit -noprompt

sudo keytool -importkeystore -deststorepass changeit -srcstorepass mypass -destkeystore /usr/share/openfire/resources/security/keystore -srckeystore cert.p12 -srcstoretype PKCS12 -deststoretype pkcs12

chown openfire:openfire /usr/share/openfire/resources/security/keystore

systemctl restart openfire
sudo netstat -tulnp | grep java

</code></pre>
<p>open http://DOMAIN:9090/ to configure the server (HTTPS will be configured later on)</p>
<p><code>sudo vi /etc/letsencrypt/renewal-hooks/post/openfire.sh</code></p>
<p>Some findings:</p>
<blockquote>
<p>privkey is your private key. It is not the same as a Certificate Signing Request (CSR) file. Don't ever send the private key offsite. It's never meant to be seen by your CA (Letsencrypt or otherwise).</p>
<p>However, you should be able to import the private key and the generated certificate file from Letsencrypt back into your Java based application such as openfire. I don't exactly know the keytool commands to run but it should be simple enough to read the man page/online searches.</p>
<p>That's the traditional way of doing it. You create a CSR file which is an intermediate type of file.</p>
<p>Then you open this file, copy its contents, go to your CA's website, login and paste it into some kind of web form. Then you hit submit and wait.</p>
<p>CA does its thing in the background, verifies you own the domain, etc.</p>
<p>Then eventually it'll tell you it's done and you can download the certificate and CA's own public certificate file.</p>
<p>You then take those files, copy them to your server and configure the software to use them.</p>
<p>When the certificate is up for renewal, you repeat the above process. It's all very manual.</p>
<p>The link you provided is not meant to be used with an SSL provider such as Letsencrypt. It's meant to be used with the more traditional SSL providers.</p>
<p>LE automates everything and is then supposed to automatically install the certificate in the software. OpenFire does not seem to support this so you have to do a manual letsencrypt process (IE using DNS as a method) or find scripts online written by people that have created the missing "glue" to automate it anyway.</p>
<p>You're better off looking through OpenFire's forums for people that use Letsencrypt and have already automated it for you. That, or do Letsencrypt manually and every 2 or so months, repeat. That's even more laborious (but still free).</p>
</blockquote>
            
          
        </div>
      </div>
    </div>
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        
          
            
  <h1 class="logo"><a href="../..">My KDB</a></h1>



          
            



<h3>Table Of Contents</h3>

<nav>
  
  
    <ul>
    
  </ul>
  

  
</nav>
          
            
  <h3>Related Topics</h3>
  <ul>
    
      <li>Previous: <a href="../OPNSense%20on%20KVM%20hosting/" title="previous chapter">
        OPNSense on KVM hosting
      </a></li>
    
    
      <li>Next: <a href="../OpenFlow%20%26%20WSL%20on%20Windows%20Server%20%28notes%29/" title="next chapter">
        OpenFlow & WSL on Windows Server (notes)
      </a></li>
    
  </ul>

          
            <div id="searchbox" style="display: none;" role="search">
  <h3>Quick search</h3>
  <form class="search" action="../../search.html" method="get">
    <input name="q" type="text">
    <input value="Go" type="submit">
  </form>
  <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
  </p>
</div>
<script type="text/javascript">
  document.getElementById("searchbox").style.display = "block";
</script>
          
        
      </div>
    </div>
    <div class="clearer"></div>
  </div>

  
    <div class="footer">
      
      
        
        Powered by <a href="http://www.mkdocs.org">mkdocs 1.4.2</a>
        &amp; <a href="https://github.com/iamale/mkdocs-alabaster">mkdocs-alabaster</a>
      
    </div>
  

  <!--
  MkDocs version      : 1.4.2
  Docs Build Date UTC : 2022-11-29 15:13:35.270769+00:00
  -->
</body>
</html>