
<!DOCTYPE html>
<html>
<head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>Server setup &mdash; My KDB</title>

    <link rel="shortcut icon" href="../../img/favicon.ico">
    <link rel="stylesheet" href="../../css/alabaster.css" type="text/css">
    <link rel="stylesheet" href="../../css/alabaster-overrides.css" type="text/css">

    

    
      <script src="../../search/main.js"></script>
    

    

    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

    
  
</head>
<body>

  <div class="document">
    <div class="documentwrapper">
      <div class="bodywrapper">
        <div class="body" role="main">
          
            <h1 id="server-setup">Server setup</h1>
<pre><code class="language-bash"># Generic part
sudo su -
apt update &amp;&amp; apt upgrade
fallocate -l 1G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
swapon --show
echo &quot;/swapfile    none    swap    sw    0   0&quot; &gt;&gt; /etc/fstab
apt install -y unattended-upgrades update-notifier-common apt-listchanges

vim /etc/apt/apt.conf.d/50unattended-upgrades
unattended-upgrades --dry-run

dpkg-reconfigure tzdata

# OpenVPN server preparation
curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
chmod +x openvpn-install.sh
sudo ./openvpn-install.sh # Ctrl + C it before creating new user
sudo sh -c 'echo &quot;set_var EASYRSA_CERT_EXPIRE 3600&quot; &gt;&gt; /etc/openvpn/easy-rsa/vars' # to extend certificates to almost 10 years
sudo sh -c 'echo &quot;local 127.0.0.1&quot; &gt;&gt; /etc/openvpn/server.conf'

sudo sh -c 'echo &quot;route `curl -s ifconfig.co` 255.255.255.255 net_gateway&quot; &gt;&gt; /etc/openvpn/client-template.txt'
sudo sed -e '/^remote / s/^#*/#/' -i /etc/openvpn/client-template.txt # possible issue check: grep remote-cert-tls /etc/openvpn/client-template.txt - it should be not commented
sudo sh -c 'echo &quot;remote 127.0.0.1 1984&quot; &gt;&gt; /etc/openvpn/client-template.txt'

# Cloak server installation
sudo su -
apt update &amp;&amp; apt install -y nginx certbot python3-certbot-nginx net-tools

# have DNS name binded to the server
certbot --nginx --register-unsafely-without-email # choose redirect all HTTP traffic to HTTPS

sed -e 's/listen 443 ssl;/listen 6443 ssl;/' -i /etc/nginx/sites-available/default
sed -e 's/listen \[::\]:443 ssl ipv6only=on;/listen \[::\]:6443 ssl ipv6only=on;/' -i /etc/nginx/sites-available/default
systemctl restart nginx
netstat -tulnp | grep 443 | grep -v 6443 # shall be empty

wget https://github.com/cbeuw/Cloak/releases/download/v2.6.0/ck-server-linux-amd64-v2.6.0
chmod +x ck-server-linux-amd64-v2.6.0 &amp;&amp; cp ck-server-linux-amd64-v2.6.0 /usr/local/bin/ck-server
setcap CAP_NET_BIND_SERVICE=+eip /usr/local/bin/ck-server

ck-server -key | tee cloak.keys
cat cloak.keys | tail -1 | awk --field-separator=&quot;:&quot; '{print $2}' | xargs | cut -c 6- &gt; cloak-private.key
cat cloak.keys | head -1 | awk --field-separator=&quot;:&quot; '{print $2}' | xargs | cut -c 6- &gt; cloak-public.key
ck-server -u | tee cloak-admin.key #admin
ck-server -u | tee cloak-user.key #first user
mkdir /etc/cloak

# adjust OpenVPN port (1194) here is you installed OpenVPN on a non-standard port
sudo tee -a /etc/cloak/ckserver.json  &gt; /dev/null &lt;&lt;EOT
{
  &quot;ProxyBook&quot;: {
    &quot;openvpn&quot;: [
      &quot;tcp&quot;,
      &quot;127.0.0.1:1194&quot;
    ]
  },
  &quot;BindAddr&quot;: [
    &quot;:443&quot;
  ],
  &quot;BypassUID&quot;: [
    &quot;CLOAK-USER-KEY&quot;
  ],
  &quot;RedirAddr&quot;: &quot;127.0.0.1:6443&quot;,
  &quot;PrivateKey&quot;: &quot;CLOAK-PRIVATE-KEY&quot;,
  &quot;AdminUID&quot;: &quot;CLOAK-ADMIN-KEY&quot;,
  &quot;DatabasePath&quot;: &quot;/etc/cloak/userinfo.db&quot;,
  &quot;StreamTimeout&quot;: 300
}
EOT

sed &quot;s/CLOAK-USER-KEY/`cat cloak-user.key`/&quot; -i /etc/cloak/ckserver.json
sed &quot;s/CLOAK-ADMIN-KEY/`cat cloak-admin.key`/&quot; -i /etc/cloak/ckserver.json
sed &quot;s|CLOAK-PRIVATE-KEY|`cat cloak-private.key`|&quot; -i /etc/cloak/ckserver.json

sudo ck-server -c /etc/cloak/ckserver.json -verbosity Trace # if no errors, Ctrl + C and go forward

sudo tee -a ~/ckclient.json &gt; /dev/null &lt;&lt;EOT
{
  &quot;Transport&quot;: &quot;direct&quot;,
  &quot;ProxyMethod&quot;: &quot;openvpn&quot;,
  &quot;EncryptionMethod&quot;: &quot;aes-gcm&quot;,
  &quot;UID&quot;: &quot;CLOAK-USER-KEY&quot;,
  &quot;PublicKey&quot;: &quot;CLOAK-PUBLIC-KEY&quot;,
  &quot;ServerName&quot;: &quot;CLOAK-DNS-NAME&quot;,
  &quot;NumConn&quot;: 8,
  &quot;BrowserSig&quot;: &quot;chrome&quot;,
  &quot;StreamTimeout&quot;: 300,
  &quot;RemoteHost&quot;: &quot;CLOAK-DNS-NAME&quot;,
  &quot;RemotePort&quot;: &quot;443&quot;
}
EOT

sed &quot;s/CLOAK-USER-KEY/`cat cloak-user.key`/&quot; -i ~/ckclient.json
sed &quot;s|CLOAK-PUBLIC-KEY|`cat cloak-public.key`|&quot; -i ~/ckclient.json
sed &quot;s/CLOAK-DNS-NAME/YOURDNSNAME/g&quot; -i ~/ckclient.json # replace with your DNS name

#path as per man 5 systemd.unit
sudo tee -a /etc/systemd/system/cloak.service  &gt; /dev/null &lt;&lt;EOT
[Unit]  
Description=Cloak Server  
After=network.target  

[Service]  
Type=simple  
ExecStart=/usr/local/bin/ck-server -c /etc/cloak/ckserver.json  
Restart=on-failure  

[Install]  
WantedBy=multi-user.target
EOT


systemctl enable cloak
systemctl start cloak
systemctl status cloak
ss -tulpn | grep 443

</code></pre>
<h1 id="linux-client">Linux client</h1>
<p>Install the client (for 22.04 LTS; for others modify URL as per <a href="https://openvpn.net/cloud-docs/openvpn-3-client-for-linux/#:~:text=Type%20the%20following%20command%20into%20the%20Terminal:%20sudo%20apt%20update,install%20the%20OpenVPN%203%20package">this</a> page)</p>
<pre><code>sudo apt install apt-transport-https
sudo wget https://swupdate.openvpn.net/repos/openvpn-repo-pkg-key.pub
sudo apt-key add openvpn-repo-pkg-key.pub
sudo wget -O /etc/apt/sources.list.d/openvpn3.list https://swupdate.openvpn.net/community/openvpn3/repos/openvpn3-jammy.list
sudo apt update
sudo apt install openvpn3
</code></pre>
<p><code>start script</code></p>
<pre><code class="language-bash">#!/bin/bash
set -x
set -e

if [ ! -f &quot;ck-client&quot; ]; then
    wget https://github.com/cbeuw/Cloak/releases/download/v2.6.0/ck-client-linux-amd64-v2.6.0
    chmod +x ck-client-linux-amd64-v2.6.0 &amp;&amp; mv ck-client-linux-amd64-v2.6.0 ck-client
fi

if [ ! -f &quot;ckclient.json&quot; ]; then
    echo &quot;Cloak config file missing&quot;;
    exit 1;
fi

sudo rm -f /tmp/cloak.log /tmp/openvpn.log
echo &quot;Starting Cloak&quot;
sudo nohup ./ck-client -c ckclient.json  -verbosity Info &amp;&gt; /tmp/cloak.log &amp;
sudo tail /tmp/cloak.log
echo &quot;A little break&quot;
sleep 5
sudo nohup openvpn3 session-start --config *.ovpn &amp;&gt; /tmp/openvpn.log &amp;
</code></pre>
<p><code>stop script</code></p>
<pre><code class="language-bash">#!/bin/bash
sudo openvpn3 sessions-list
sudo openvpn3 session-manage --config *.ovpn --disconnect
sudo killall ck-client
#while true; do clear &amp;&amp; sudo openvpn3 log --log-level 6 --config *.ovpn; sleep 1; done

</code></pre>
<p><code>status script</code></p>
<pre><code class="language-bash">#!/bin/bash
sudo openvpn3 sessions-list
sudo openvpn3 log --log-level 6 --config *.ovpn
</code></pre>
<h1 id="macos-client">MacOS client</h1>
<p>Download <a href="https://tunnelblick.net/downloads.html">stable version of TunnelBlick</a> OpenVPN client.<br />
<code>cloak.sh</code></p>
<pre><code class="language-bash">#!/bin/bash

if [ ! -f &quot;ck-client&quot; ]; then
    wget https://github.com/cbeuw/Cloak/releases/download/v2.6.0/ck-client-darwin-amd64-v2.6.0
    chmod +x ck-client-darwin-amd64-v2.6.0 &amp;&amp; mv ck-client-linux-amd64-v2.6.0 ck-client
fi

if [ ! -f &quot;ckclient.json&quot; ]; then
    echo &quot;Cloak config file missing&quot;;
    exit 1;
fi

./ck-client -c ckclient.json
</code></pre>
<h1 id="windows-client">Windows client</h1>
<p>Download <a href="https://openvpn.net/community-downloads/">Community edition</a> of the OpenVPN client</p>
<pre><code>curl.exe -L -o ck-client.exe https://github.com/cbeuw/Cloak/releases/download/v2.6.0/ck-client-windows-amd64-v2.6.0.exe
.\ck-client -c ckclient.json
</code></pre>
<p><code>start.bat</code></p>
<pre><code>.\ck-client -c ckclient.json
</code></pre>
<h1 id="adding-new-clients">Adding new clients</h1>
<ul>
<li>ssh to cloaked openvpn server</li>
<li>create new openvpn client with the script</li>
<li>pass over template connection folder + personal script to be installed by a HelpDesk</li>
</ul>
<h1 id="securing">Securing</h1>
<ul>
<li>change nginx to <code>listen</code> on <code>127.0.0.1:6443</code> to ensure it's not available from the outside at all</li>
<li>if you apply <code>ufw</code> than be aware that an access of the internal hosts might not be available</li>
</ul>
<h1 id="troubleshooting">Troubleshooting</h1>
<ul>
<li>Cloak logging library is <a href="https://github.com/sirupsen/logrus">logrus</a> , Trace, Debug, Info, Warning, Error, Fatal and Panic logging options available</li>
<li>Client side logs are at <code>/tmp/cloak.log</code>  &amp; <code>/tmp/openvpn.log</code>; server side logs are at syslog</li>
<li>Server side cloak configs are at <code>sudo su -</code></li>
<li>add <code>management 127.0.0.1 5555</code> to <code>/etc/openvpn/server.conf</code>, followed by <code>sudo service openvpn restart</code> to enable <code>telnet 127.0.0.1 5555</code> which will respond to <code>status</code> command</li>
<li>Before anything, verify the ports are correct</li>
</ul>
<p>Server HW note: 20Gb HDD, 2GB RAM, 2GHz CPU</p>
            
          
        </div>
      </div>
    </div>
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        
          
            
  <h1 class="logo"><a href="../..">My KDB</a></h1>



          
            



<h3>Table Of Contents</h3>

<nav>
  
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  
    <ul>
    
  </ul>
  

  
</nav>
          
            
  <h3>Related Topics</h3>
  <ul>
    
      <li>Previous: <a href="../ChatSDK/" title="previous chapter">
        ChatSDK (draft)
      </a></li>
    
    
      <li>Next: <a href="../CloudRon%20%28managed%20apps%29/" title="next chapter">
        CloudRon (managed apps)
      </a></li>
    
  </ul>

          
            <div id="searchbox" style="display: none;" role="search">
  <h3>Quick search</h3>
  <form class="search" action="../../search.html" method="get">
    <input name="q" type="text">
    <input value="Go" type="submit">
  </form>
  <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
  </p>
</div>
<script type="text/javascript">
  document.getElementById("searchbox").style.display = "block";
</script>
          
        
      </div>
    </div>
    <div class="clearer"></div>
  </div>

  
    <div class="footer">
      
      
        
        Powered by <a href="http://www.mkdocs.org">mkdocs 1.4.2</a>
        &amp; <a href="https://github.com/iamale/mkdocs-alabaster">mkdocs-alabaster</a>
      
    </div>
  

  <!--
  MkDocs version      : 1.4.2
  Docs Build Date UTC : 2022-11-29 15:13:35.244959+00:00
  -->
</body>
</html>